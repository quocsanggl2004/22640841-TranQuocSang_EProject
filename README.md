# EProject Microservices - Business Logic Testing

## üìã T·ªïng quan d·ª± √°n

ƒê√¢y l√† m·ªôt h·ªá th·ªëng microservices bao g·ªìm 4 services ch√≠nh:

### üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng
```
API Gateway (3000) ‚Üí Auth Service (3001)
                  ‚Üí Product Service (3002)  
                  ‚Üí Order Service (3003)
```

### üéØ Business Logic ch√≠nh:
1. **Authentication** - ƒêƒÉng k√Ω, ƒëƒÉng nh·∫≠p, x√°c th·ª±c JWT
2. **Product Management** - CRUD s·∫£n ph·∫©m
3. **Order Processing** - T·∫°o ƒë∆°n h√†ng, x·ª≠ l√Ω qua message queue
4. **API Gateway** - Routing v√† proxy requests

---

## üöÄ Quick Start

### üéØ Option 1: Automated Setup (Recommended)
```bash
# Double-click ƒë·ªÉ ch·∫°y automated setup
setup.bat

# Ho·∫∑c ch·∫°y t·ª´ terminal:
./setup.bat
```

### üõ†Ô∏è Option 2: Manual Setup

#### 1. Setup Environment
```bash
# Copy environment template
copy .env.example .env
# üáªüá≥ L√Ω do: .env.example l√† template an to√†n, .env ch·ª©a config th·∫≠t

# Install dependencies cho t·∫•t c·∫£ services
npm run install:all
```

#### 2. Configure Environment
Edit file `.env` v·ªõi config th·∫≠t c·ªßa b·∫°n:
```bash
# Example: Thay ƒë·ªïi JWT secret
JWT_SECRET=YourRealSecretKey123!@#

# Example: N·∫øu d√πng MongoDB v·ªõi authentication
MONGODB_AUTH_URI=mongodb://admin:password@localhost:27017/auth_db
```

#### 3. Start Database
```bash
# Option A: Local MongoDB
mongod --dbpath="C:\data\db"

# Option B: Docker MongoDB  
docker-compose up mongodb

# Option C: MongoDB Atlas (cloud) - update .env v·ªõi Atlas URI
```

#### 4. Start Services
```bash
# Development mode (hot reload)
npm run dev

# Production mode
npm start

# With Docker (all services + MongoDB + RabbitMQ)
npm run docker:up
```

### 2. Verify Services
Ki·ªÉm tra t·∫•t c·∫£ services ƒëang ch·∫°y:
- http://localhost:3000/health (API Gateway)
- http://localhost:3001/health (Auth Service)
- http://localhost:3002/health (Product Service)
- http://localhost:3003/health (Order Service)

### üáªüá≥ Troubleshooting:
- **MongoDB**: N·∫øu connection error, check MongoDB ƒëang ch·∫°y ch∆∞a
- **RabbitMQ**: N·∫øu message queue error, install RabbitMQ ho·∫∑c d√πng Docker
- **Port conflicts**: Check ports 3000-3003 c√≥ b·ªã occupy kh√¥ng
- **.env missing**: Ch·∫°y `setup.bat` ho·∫∑c manual copy `.env.example` ‚Üí `.env`

---

## üß™ Test Business Logic v·ªõi POSTMAN

### Collection Setup
T·∫°o Postman Collection v·ªõi environment variables:
```json
{
  "gateway_url": "http://localhost:3000",
  "auth_url": "http://localhost:3001", 
  "product_url": "http://localhost:3002",
  "order_url": "http://localhost:3003",
  "token": ""
}
```

---

## üîê 1. Authentication Business Logic

> **üáªüá≥ L∆∞u √Ω**: Auth service ch·ªâ y√™u c·∫ßu `username` v√† `password`, kh√¥ng c·∫ßn email

### Test Case 1.1: User Registration
```http
POST {{auth_url}}/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**Expected Result:**
- Status: 200 OK (‚ö†Ô∏è Note: Tr·∫£ v·ªÅ 200, kh√¥ng ph·∫£i 201)
- Response: User object v·ªõi `_id` v√† `username`
- Database: New user record v·ªõi password ƒë√£ hash

> **üáªüá≥ Gi·∫£i th√≠ch**: Service d√πng bcrypt ƒë·ªÉ hash password tr∆∞·ªõc khi l∆∞u DB

### Test Case 1.2: User Login
```http
POST {{auth_url}}/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**Expected Result:**
- Status: 200 OK
- Response: `{ "token": "jwt_token_here" }`
- Save token to environment variable

> **üáªüá≥ Quan tr·ªçng**: Token ƒë∆∞·ª£c generate b·∫±ng user ID, kh√¥ng ph·∫£i username

### Test Case 1.3: Protected Route Access
```http
GET {{auth_url}}/dashboard
x-auth-token: {{token}}
```

**Expected Result:**
- Status: 200 OK with valid token
- Status: 401 Unauthorized without token
- Response: `{ "message": "Welcome to dashboard" }`

> **üáªüá≥ L∆∞u √Ω**: Auth middleware d√πng header `x-auth-token`, kh√¥ng ph·∫£i `Authorization: Bearer`

### Test Case 1.4: Token Verification  
```http
GET {{auth_url}}/verify
Authorization: Bearer {{token}}
```

**Expected Result:**
- Status: 200 OK
- Response: `{ "user": decoded_user, "message": "Token is valid" }`

> **üáªüá≥ Ch√∫ √Ω**: Endpoint n√†y d√πng `Authorization: Bearer`, kh√°c v·ªõi dashboard

---

## üì¶ 2. Product Management Business Logic

> **üáªüá≥ Quan tr·ªçng**: T·∫•t c·∫£ product endpoints ƒë·ªÅu require authentication

### Test Case 2.1: Create Product
```http
POST {{product_url}}/api/products
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "Test Product",
  "description": "Product description", 
  "price": 99.99
}
```

**Expected Result:**
- Status: 201 Created
- Response: Product object v·ªõi MongoDB `_id`
- Database: New product record

> **üáªüá≥ Schema**: Ch·ªâ c·∫ßn `name`, `price` (required) v√† `description` (optional)

### Test Case 2.2: Get All Products
```http
GET {{product_url}}/api/products
Authorization: Bearer {{token}}
```

**Expected Result:**
- Status: 200 OK
- Response: Array of all products
- ‚ö†Ô∏è **Authentication required** (kh√°c v·ªõi m√¥ t·∫£ ban ƒë·∫ßu)

### Test Case 2.3: Create Order via Product Service
```http
POST {{product_url}}/api/products/buy
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "ids": ["product_id_1", "product_id_2"]
}
```

**Expected Result:**
- Status: 201 Created
- Response: Complete order v·ªõi status "completed"
- Message Queue: Order published v√† processed
- Long polling: Ch·ªù ƒë·∫øn khi order ho√†n th√†nh

> **üáªüá≥ ƒê·∫∑c bi·ªát**: Endpoint n√†y implement long polling v√† message queue processing

### Test Case 2.4: Get Order Status
```http
GET {{product_url}}/api/products/order/{{order_id}}
Authorization: Bearer {{token}}
```

**Expected Result:**
- Status: 200 OK ho·∫∑c 404 Not Found
- Response: Order status v√† details

---

## üõí 3. Order Processing Business Logic

### Test Case 3.1: Create Order (Direct)
```http
POST {{order_url}}/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "products": [
    {
      "name": "Test Product",
      "price": 99.99
    }
  ]
}
```

**Expected Result:**
- Status: 201 Created
- Response: Order v·ªõi calculated `totalPrice`
- Database: Order record v·ªõi user t·ª´ JWT token

> **üáªüá≥ T√≠nh nƒÉng**: Service t·ª± ƒë·ªông t√≠nh t·ªïng ti·ªÅn t·ª´ array products

### Test Case 3.2: Get User Orders
```http
GET {{order_url}}/
Authorization: Bearer {{token}}
```

**Expected Result:**
- Status: 200 OK
- Response: Array orders c·ªßa user hi·ªán t·∫°i
- Filtered by `req.user.username` t·ª´ JWT

### Test Case 3.3: Get Specific Order
```http
GET {{order_url}}/{{order_id}}
Authorization: Bearer {{token}}
```

**Expected Result:**
- Status: 200 OK for existing order
- Status: 404 for non-existent order

---

## üåê 4. API Gateway Business Logic

### Test Case 4.1: Auth Proxy
```http
POST {{gateway_url}}/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "password123"
}
```

**Expected Result:**
- Request proxied to `http://localhost:3001`
- Same response as direct auth call
- 5000ms timeout configured

### Test Case 4.2: Product Proxy
```http
GET {{gateway_url}}/products/api/products
Authorization: Bearer {{token}}
```

**Expected Result:**
- Request proxied to `http://localhost:3002`
- Path: `/products/api/products` ‚Üí `/api/products` on service

### Test Case 4.3: Order Proxy
```http
GET {{gateway_url}}/orders/
Authorization: Bearer {{token}}
```

**Expected Result:**
- Request proxied to `http://localhost:3003`
- Headers preserved including Authorization

### Test Case 4.4: Gateway Health Check
```http
GET {{gateway_url}}/health
```

**Expected Result:**
- Status: 200 OK
- Response: `{ "status": "API Gateway is running", "timestamp": "..." }`

---

## üîÑ 5. Message Queue Business Logic

> **üáªüá≥ Ki·∫øn tr√∫c**: RabbitMQ v·ªõi 2 queues: "orders" v√† "products"

### Test Case 5.1: Order Processing Flow
1. **Product Service**: POST `/api/products/buy` v·ªõi product IDs
2. **Message Published**: Order data sent to "orders" queue
3. **Order Service**: Consumer processing order
4. **Response Sent**: Completion message to "products" queue  
5. **Product Service**: Long polling until order completed

**Message Flow:**
```
Product Service ‚Üí "orders" queue ‚Üí Order Service
Order Service ‚Üí "products" queue ‚Üí Product Service
```

**Expected Behavior:**
- Order message contains: `{ products, username, orderId }`
- Order saved to database v·ªõi user info
- Completion message v·ªõi order details
- Product service returns completed order

> **üáªüá≥ Timeout**: RabbitMQ connection c√≥ delay 5-20 seconds khi start

---

## üìä 6. Gaps v√† Missing Logic

### ‚ö†Ô∏è Missing Implementations

#### Product Service:
```javascript
// Missing: Update Product
PUT {{product_url}}/api/products/{{product_id}}
// Missing: Delete Product  
DELETE {{product_url}}/api/products/{{product_id}}
// Missing: Get Product by ID
GET {{product_url}}/api/products/{{product_id}}
```

#### Auth Service:
```javascript
// Missing: Get User Profile
GET {{auth_url}}/profile
// Missing: Update Password
PUT {{auth_url}}/password
// Missing: Logout (token blacklist)
POST {{auth_url}}/logout
```

#### Order Service: 
```javascript
// Missing: Update Order Status
PUT {{order_url}}/{{order_id}}/status
// Missing: Cancel Order
DELETE {{order_url}}/{{order_id}}
```

### üîß Issues c·∫ßn Fix:

1. **Authentication Inconsistency**: 
   - Dashboard d√πng `x-auth-token` header
   - Verify d√πng `Authorization: Bearer` header
   - Product/Order services d√πng `Authorization: Bearer`

2. **Product Routes**: Route `/` conflict v·ªõi health check

3. **Error Handling**: Thi·∫øu proper error responses v√† validation

4. **Order Model**: Schema thi·∫øu user field trong model definition

---

## üõ†Ô∏è Testing Environment Setup

### Prerequisites
```bash
# MongoDB
mongod --dbpath="path/to/data"

# RabbitMQ  
rabbitmq-server
# Management UI: http://localhost:15672 (guest/guest)
```

### Postman Environment Variables
```json
{
  "gateway_url": "http://localhost:3000",
  "auth_url": "http://localhost:3001",
  "product_url": "http://localhost:3002", 
  "order_url": "http://localhost:3003",
  "token": "",
  "user_id": "",
  "product_id": "",
  "order_id": ""
}
```

### Collection Scripts
```javascript
// Pre-request Script (for auth)
if (pm.environment.get("token")) {
    pm.request.headers.add({
        key: "Authorization",
        value: "Bearer " + pm.environment.get("token")
    });
}

// Test Script (save response data)
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

// Save token from login
if (pm.response.json().token) {
    pm.environment.set("token", pm.response.json().token);
}

// Save product ID
if (pm.response.json()._id) {
    pm.environment.set("product_id", pm.response.json()._id);
}
```

---

## üêõ Common Test Scenarios

### Error Handling Tests
- Invalid credentials ‚Üí 400 v·ªõi message
- Missing authentication ‚Üí 401 Unauthorized  
- Invalid product data ‚Üí 400 v·ªõi validation error
- Database connection errors ‚Üí 500 Server error
- Service unavailability ‚Üí 500 qua gateway

### Edge Cases
- Empty request bodies ‚Üí 400 Bad Request
- Invalid JSON format ‚Üí 400 Bad Request
- Very long strings ‚Üí Validation error
- Special characters in data ‚Üí Proper encoding
- Concurrent requests ‚Üí Data consistency
- Service timeout ‚Üí 500 after 5000ms

---

## üìù Test Documentation

### Test Results Format
```
‚úÖ PASS: User can register v·ªõi username/password
‚úÖ PASS: User can login v√† receive JWT token  
‚ùå FAIL: Dashboard endpoint d√πng sai header format
‚úÖ PASS: Product creation requires valid JWT
‚úÖ PASS: Order total calculation ƒë√∫ng logic
‚ö†Ô∏è  WARN: Missing CRUD endpoints cho Product
```

### üáªüá≥ L∆∞u √Ω quan tr·ªçng:
1. **Headers**: Ch√∫ √Ω s·ª± kh√°c bi·ªát gi·ªØa `x-auth-token` v√† `Authorization: Bearer`
2. **Responses**: M·ªôt s·ªë endpoint tr·∫£ v·ªÅ 200 thay v√¨ 201 cho creation
3. **Message Queue**: C·∫ßn ƒë·ª£i RabbitMQ start up (5-20 gi√¢y)
4. **Long Polling**: Product buy endpoint c√≥ th·ªÉ m·∫•t v√†i gi√¢y
5. **Database**: M·ªói service d√πng separate MongoDB database

---

## üéØ Testing Checklist

### Authentication Service ‚úÖ
- [x] User registration (username/password only)
- [x] User login (JWT generation)  
- [x] Token validation (2 different header formats)
- [x] Protected routes (dashboard)
- [x] Invalid credentials handling
- [ ] ‚ùå Missing: Profile management, password update

### Product Service ‚ö†Ô∏è  
- [x] Product creation (authenticated)
- [x] Get all products (authenticated)
- [x] Order creation via buy endpoint
- [x] Long polling cho order completion
- [ ] ‚ùå Missing: Update, Delete, Get by ID

### Order Service ‚úÖ
- [x] Order creation (manual)
- [x] Order retrieval by user
- [x] Get specific order
- [x] Message queue consumption
- [ ] ‚ùå Missing: Order status updates, cancellation

### API Gateway ‚úÖ
- [x] Request routing to all services
- [x] Response proxying
- [x] Error handling (500 for unavailable services)
- [x] CORS headers
- [x] Health check endpoint

### Integration ‚ö†Ô∏è
- [x] Service communication qua gateway
- [x] Message queue flow (orders ‚Üî products)
- [x] JWT token passing
- [ ] ‚ùå Missing: Error propagation consistency
- [ ] ‚ùå Missing: Service discovery/health monitoring